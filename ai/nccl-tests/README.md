# NCCL Tests

## 运行

```sh
# 根据集群实际硬件配置进行修改
kubectl apply -f nccl-tests-h100.yml

# 查询测试结果
kubectl logs -f nccl-test-h100-launcher-xxx

kubectl delete -f nccl-tests-h100.yml
```

## 参考结果

### H100

#### 16x H100 NVLink + 8x 400Gbps IB + all reduce 

```
#                                                              out-of-place                       in-place          
#       size         count      type   redop    root     time   algbw   busbw #wrong     time   algbw   busbw #wrong
#        (B)    (elements)                               (us)  (GB/s)  (GB/s)            (us)  (GB/s)  (GB/s)       
   536870912     134217728     float     sum      -1   2622.9  204.69  383.79      0   2622.4  204.72  383.86      0
  1073741824     268435456     float     sum      -1   5200.4  206.47  387.14      0   5199.4  206.51  387.21      0
  2147483648     536870912     float     sum      -1    10308  208.32  390.61      0    10389  206.70  387.57      0
  4294967296    1073741824     float     sum      -1    20528  209.22  392.29      0    20530  209.21  392.27      0
  8589934592    2147483648     float     sum      -1    41145  208.77  391.45      0    41008  209.47  392.76      0
# Out of bounds values : 0 OK
# Avg bus bandwidth    : 388.893 
```

### H800 

* H800 SXM NVLink 双向带宽 400GB/s

#### 32x H800 NVLink + 4x 400Gbps IB + all reduce 

```
#                                                              out-of-place                       in-place
#       size         count      type   redop    root     time   algbw   busbw #wrong     time   algbw   busbw #wrong
#        (B)    (elements)                               (us)  (GB/s)  (GB/s)            (us)  (GB/s)  (GB/s)
           8             2     float     sum      -1    76.55    0.00    0.00      0    39.98    0.00    0.00      0
          16             4     float     sum      -1    40.49    0.00    0.00      0    40.05    0.00    0.00      0
          32             8     float     sum      -1    44.09    0.00    0.00      0    41.10    0.00    0.00      0
          64            16     float     sum      -1    40.70    0.00    0.00      0    40.65    0.00    0.00      0
         128            32     float     sum      -1    40.79    0.00    0.01      0    40.57    0.00    0.01      0
         256            64     float     sum      -1    41.11    0.01    0.01      0    41.16    0.01    0.01      0
         512           128     float     sum      -1    41.18    0.01    0.02      0    41.53    0.01    0.02      0
        1024           256     float     sum      -1    43.27    0.02    0.04      0    43.19    0.02    0.04      0
        2048           512     float     sum      -1    44.88    0.05    0.09      0    45.09    0.05    0.09      0
        4096          1024     float     sum      -1    48.04    0.09    0.16      0    47.16    0.09    0.16      0
        8192          2048     float     sum      -1    48.83    0.17    0.31      0    48.57    0.17    0.32      0
       16384          4096     float     sum      -1    50.56    0.32    0.61      0    49.86    0.33    0.62      0
       32768          8192     float     sum      -1    52.59    0.62    1.17      0    52.20    0.63    1.18      0
       65536         16384     float     sum      -1    56.32    1.16    2.18      0    56.13    1.17    2.19      0
      131072         32768     float     sum      -1    59.67    2.20    4.12      0    59.87    2.19    4.10      0
      262144         65536     float     sum      -1    62.46    4.20    7.87      0    61.05    4.29    8.05      0
      524288        131072     float     sum      -1    94.35    5.56   10.42      0    92.19    5.69   10.66      0
     1048576        262144     float     sum      -1    117.7    8.91   16.71      0    113.6    9.23   17.31      0
     2097152        524288     float     sum      -1    131.6   15.94   29.89      0    131.3   15.97   29.94      0
     4194304       1048576     float     sum      -1    161.2   26.03   48.80      0    160.6   26.11   48.96      0
     8388608       2097152     float     sum      -1    191.3   43.86   82.24      0    190.7   43.98   82.46      0
    16777216       4194304     float     sum      -1    265.7   63.15  118.40      0    266.7   62.91  117.95      0
    33554432       8388608     float     sum      -1    476.0   70.49  132.17      0    486.1   69.03  129.43      0
    67108864      16777216     float     sum      -1    888.6   75.52  141.60      0    887.2   75.64  141.83      0
   134217728      33554432     float     sum      -1   1572.3   85.36  160.05      0   1573.4   85.30  159.94      0
   268435456      67108864     float     sum      -1   3108.0   86.37  161.94      0   3108.6   86.35  161.91      0
   536870912     134217728     float     sum      -1   6172.5   86.98  163.08      0   6170.7   87.00  163.13      0
  1073741824     268435456     float     sum      -1    12275   87.48  164.02      0    12276   87.47  164.00      0
  2147483648     536870912     float     sum      -1    24476   87.74  164.51      0    24464   87.78  164.59      0
  4294967296    1073741824     float     sum      -1    49773   86.29  161.80      0    48836   87.95  164.90      0
  8589934592    2147483648     float     sum      -1    97581   88.03  165.05      0    97550   88.06  165.11      0
# Out of bounds values : 0 OK
# Avg bus bandwidth    : 56.0677
```

#### 8x H800 NVLink + all reduce 

```
#                                                              out-of-place                       in-place
#       size         count      type   redop    root     time   algbw   busbw #wrong     time   algbw   busbw #wrong
#        (B)    (elements)                               (us)  (GB/s)  (GB/s)            (us)  (GB/s)  (GB/s)
           8             2     float     sum      -1    30.74    0.00    0.00      0    14.87    0.00    0.00      0
          16             4     float     sum      -1    14.96    0.00    0.00      0    14.95    0.00    0.00      0
          32             8     float     sum      -1    15.29    0.00    0.00      0    14.86    0.00    0.00      0
          64            16     float     sum      -1    15.16    0.00    0.01      0    15.12    0.00    0.01      0
         128            32     float     sum      -1    15.41    0.01    0.01      0    15.11    0.01    0.01      0
         256            64     float     sum      -1    15.53    0.02    0.03      0    15.28    0.02    0.03      0
         512           128     float     sum      -1    15.69    0.03    0.06      0    15.50    0.03    0.06      0
        1024           256     float     sum      -1    16.24    0.06    0.11      0    16.05    0.06    0.11      0
        2048           512     float     sum      -1    17.32    0.12    0.21      0    17.11    0.12    0.21      0
        4096          1024     float     sum      -1    18.52    0.22    0.39      0    18.02    0.23    0.40      0
        8192          2048     float     sum      -1    19.20    0.43    0.75      0    18.44    0.44    0.78      0
       16384          4096     float     sum      -1    19.75    0.83    1.45      0    19.02    0.86    1.51      0
       32768          8192     float     sum      -1    21.28    1.54    2.69      0    20.36    1.61    2.82      0
       65536         16384     float     sum      -1    21.27    3.08    5.39      0    20.51    3.19    5.59      0
      131072         32768     float     sum      -1    22.11    5.93   10.37      0    21.02    6.24   10.91      0
      262144         65536     float     sum      -1    22.00   11.91   20.85      0    21.23   12.35   21.61      0
      524288        131072     float     sum      -1    23.57   22.25   38.93      0    23.11   22.69   39.71      0
     1048576        262144     float     sum      -1    37.65   27.85   48.74      0    37.00   28.34   49.59      0
     2097152        524288     float     sum      -1    45.95   45.64   79.88      0    46.17   45.43   79.50      0
     4194304       1048576     float     sum      -1    70.01   59.91  104.84      0    69.84   60.05  105.10      0
     8388608       2097152     float     sum      -1    123.0   68.18  119.32      0    122.9   68.26  119.46      0
    16777216       4194304     float     sum      -1    210.3   79.77  139.60      0    207.6   80.82  141.43      0
    33554432       8388608     float     sum      -1    388.2   86.43  151.25      0    387.7   86.55  151.46      0
    67108864      16777216     float     sum      -1    749.8   89.50  156.63      0    749.3   89.56  156.73      0
   134217728      33554432     float     sum      -1   1477.1   90.87  159.02      0   1476.7   90.89  159.06      0
   268435456      67108864     float     sum      -1   2915.1   92.08  161.15      0   2917.7   92.00  161.01      0
   536870912     134217728     float     sum      -1   5769.8   93.05  162.83      0   5769.4   93.06  162.85      0
  1073741824     268435456     float     sum      -1    11466   93.65  163.88      0    11467   93.63  163.86      0
  2147483648     536870912     float     sum      -1    22837   94.04  164.56      0    22826   94.08  164.64      0
  4294967296    1073741824     float     sum      -1    45552   94.29  165.00      0    45558   94.27  164.98      0
  8589934592    2147483648     float     sum      -1    91003   94.39  165.19      0    90995   94.40  165.20      0
# Out of bounds values : 0 OK
# Avg bus bandwidth    : 65.3513
```

#### 32x H800 NVLink + 4x 400Gbps IB + all2all 

```
#                                                              out-of-place                       in-place
#       size         count      type   redop    root     time   algbw   busbw #wrong     time   algbw   busbw #wrong
#        (B)    (elements)                               (us)  (GB/s)  (GB/s)            (us)  (GB/s)  (GB/s)
           0             0     float    none      -1    76.24    0.00    0.00      0    52.48    0.00    0.00    N/A
           0             0     float    none      -1    49.99    0.00    0.00      0    44.91    0.00    0.00    N/A
           0             0     float    none      -1    44.98    0.00    0.00      0    44.45    0.00    0.00    N/A
           0             0     float    none      -1    43.68    0.00    0.00      0    44.22    0.00    0.00    N/A
         128             1     float    none      -1    46.24    0.00    0.00      0    46.14    0.00    0.00    N/A
         256             2     float    none      -1    45.95    0.01    0.01      0    45.68    0.01    0.01    N/A
         512             4     float    none      -1    45.97    0.01    0.01      0    45.11    0.01    0.01    N/A
        1024             8     float    none      -1    63.32    0.02    0.02      0    47.09    0.02    0.02    N/A
        2048            16     float    none      -1    45.98    0.04    0.04      0    46.44    0.04    0.04    N/A
        4096            32     float    none      -1    45.85    0.09    0.09      0    46.70    0.09    0.08    N/A
        8192            64     float    none      -1    46.15    0.18    0.17      0    45.99    0.18    0.17    N/A
       16384           128     float    none      -1    47.50    0.34    0.33      0    46.53    0.35    0.34    N/A
       32768           256     float    none      -1    48.56    0.67    0.65      0    47.90    0.68    0.66    N/A
       65536           512     float    none      -1    49.66    1.32    1.28      0    47.72    1.37    1.33    N/A
      131072          1024     float    none      -1    48.22    2.72    2.63      0    48.92    2.68    2.60    N/A
      262144          2048     float    none      -1    54.47    4.81    4.66      0    53.52    4.90    4.75    N/A
      524288          4096     float    none      -1    82.55    6.35    6.15      0    68.75    7.63    7.39    N/A
     1048576          8192     float    none      -1    95.83   10.94   10.60      0    95.34   11.00   10.66    N/A
     2097152         16384     float    none      -1    145.7   14.39   13.94      0    140.7   14.90   14.44    N/A
     4194304         32768     float    none      -1    227.5   18.44   17.86      0    226.7   18.50   17.92    N/A
     8388608         65536     float    none      -1    402.3   20.85   20.20      0    399.3   21.01   20.35    N/A
    16777216        131072     float    none      -1    717.4   23.39   22.66      0    711.4   23.58   22.84    N/A
    33554432        262144     float    none      -1   1301.9   25.77   24.97      0   1332.1   25.19   24.40    N/A
    67108864        524288     float    none      -1   2503.6   26.80   25.97      0   2511.3   26.72   25.89    N/A
   134217728       1048576     float    none      -1   4788.0   28.03   27.16      0   4881.5   27.50   26.64    N/A
   268435456       2097152     float    none      -1    10200   26.32   25.49      0    10148   26.45   25.63    N/A
   536870912       4194304     float    none      -1    18202   29.50   28.57      0    19904   26.97   26.13    N/A
  1073741824       8388608     float    none      -1    38659   27.77   26.91      0    37918   28.32   27.43    N/A
  2147483648      16777216     float    none      -1    74183   28.95   28.04      0    71429   30.06   29.13    N/A
  4294967296      33554432     float    none      -1   141264   30.40   29.45      0   144148   29.80   28.86    N/A
  8589934592      67108864     float    none      -1   282400   30.42   29.47      0   286639   29.97   29.03    N/A
# Out of bounds values : 0 OK
# Avg bus bandwidth    : 11.1949
```

#### 16x H100 NVLink + 4x 400Gbps IB + all2all 

```
#                                                              out-of-place                       in-place
#       size         count      type   redop    root     time   algbw   busbw #wrong     time   algbw   busbw #wrong
#        (B)    (elements)                               (us)  (GB/s)  (GB/s)            (us)  (GB/s)  (GB/s)
           0             0     float    none      -1    29.35    0.00    0.00      0    24.49    0.00    0.00    N/A
           0             0     float    none      -1    24.48    0.00    0.00      0    23.86    0.00    0.00    N/A
           0             0     float    none      -1    24.19    0.00    0.00      0    24.30    0.00    0.00    N/A
          64             1     float    none      -1    30.82    0.00    0.00      0    29.61    0.00    0.00    N/A
         128             2     float    none      -1    29.28    0.00    0.00      0    29.43    0.00    0.00    N/A
         256             4     float    none      -1    29.36    0.01    0.01      0    29.20    0.01    0.01    N/A
         512             8     float    none      -1    29.54    0.02    0.02      0    29.52    0.02    0.02    N/A
        1024            16     float    none      -1    29.55    0.03    0.03      0    28.97    0.04    0.03    N/A
        2048            32     float    none      -1    29.07    0.07    0.07      0    29.48    0.07    0.07    N/A
        4096            64     float    none      -1    29.43    0.14    0.13      0    29.29    0.14    0.13    N/A
        8192           128     float    none      -1    29.57    0.28    0.26      0    29.21    0.28    0.26    N/A
       16384           256     float    none      -1    30.07    0.54    0.51      0    29.93    0.55    0.51    N/A
       32768           512     float    none      -1    31.31    1.05    0.98      0    31.35    1.05    0.98    N/A
       65536          1024     float    none      -1    30.86    2.12    1.99      0    30.55    2.14    2.01    N/A
      131072          2048     float    none      -1    34.22    3.83    3.59      0    33.44    3.92    3.68    N/A
      262144          4096     float    none      -1    41.78    6.27    5.88      0    41.15    6.37    5.97    N/A
      524288          8192     float    none      -1    49.76   10.54    9.88      0    50.19   10.45    9.79    N/A
     1048576         16384     float    none      -1    68.23   15.37   14.41      0    64.56   16.24   15.23    N/A
     2097152         32768     float    none      -1    94.73   22.14   20.76      0    93.23   22.49   21.09    N/A
     4194304         65536     float    none      -1    154.7   27.11   25.41      0    155.1   27.05   25.35    N/A
     8388608        131072     float    none      -1    264.2   31.75   29.77      0    269.9   31.08   29.13    N/A
    16777216        262144     float    none      -1    462.5   36.28   34.01      0    468.3   35.82   33.58    N/A
    33554432        524288     float    none      -1    849.9   39.48   37.01      0    851.9   39.39   36.93    N/A
    67108864       1048576     float    none      -1   1609.2   41.70   39.10      0   1605.9   41.79   39.18    N/A
   134217728       2097152     float    none      -1   3137.8   42.77   40.10      0   3128.1   42.91   40.23    N/A
   268435456       4194304     float    none      -1   6208.3   43.24   40.54      0   6227.3   43.11   40.41    N/A
   536870912       8388608     float    none      -1    12361   43.43   40.72      0    12275   43.74   41.00    N/A
  1073741824      16777216     float    none      -1    24580   43.68   40.95      0    24683   43.50   40.78    N/A
  2147483648      33554432     float    none      -1    50133   42.84   40.16      0    49236   43.62   40.89    N/A
  4294967296      67108864     float    none      -1    97769   43.93   41.18      0    97857   43.89   41.15    N/A
  8589934592     134217728     float    none      -1   195476   43.94   41.20      0   197507   43.49   40.77    N/A
# Out of bounds values : 0 OK
# Avg bus bandwidth    : 16.4171
```

#### 8x H100 NVLink + all2all

```
#                                                              out-of-place                       in-place
#       size         count      type   redop    root     time   algbw   busbw #wrong     time   algbw   busbw #wrong
#        (B)    (elements)                               (us)  (GB/s)  (GB/s)            (us)  (GB/s)  (GB/s)
           0             0     float    none      -1     8.70    0.00    0.00      0     7.52    0.00    0.00    N/A
           0             0     float    none      -1     7.31    0.00    0.00      0     7.42    0.00    0.00    N/A
          32             1     float    none      -1     8.44    0.00    0.00      0     8.36    0.00    0.00    N/A
          64             2     float    none      -1     8.40    0.01    0.01      0     8.25    0.01    0.01    N/A
         128             4     float    none      -1     8.41    0.02    0.01      0     8.41    0.02    0.01    N/A
         256             8     float    none      -1     8.49    0.03    0.03      0     8.27    0.03    0.03    N/A
         512            16     float    none      -1     8.42    0.06    0.05      0     8.41    0.06    0.05    N/A
        1024            32     float    none      -1     8.40    0.12    0.11      0     8.38    0.12    0.11    N/A
        2048            64     float    none      -1     8.34    0.25    0.21      0     8.43    0.24    0.21    N/A
        4096           128     float    none      -1     8.47    0.48    0.42      0     8.33    0.49    0.43    N/A
        8192           256     float    none      -1     8.57    0.96    0.84      0     8.53    0.96    0.84    N/A
       16384           512     float    none      -1     8.63    1.90    1.66      0     8.44    1.94    1.70    N/A
       32768          1024     float    none      -1     9.63    3.40    2.98      0     9.09    3.60    3.15    N/A
       65536          2048     float    none      -1    10.07    6.51    5.69      0     9.79    6.69    5.86    N/A
      131072          4096     float    none      -1    11.68   11.23    9.82      0    11.34   11.56   10.12    N/A
      262144          8192     float    none      -1    13.60   19.27   16.86      0    12.88   20.35   17.80    N/A
      524288         16384     float    none      -1    16.15   32.46   28.40      0    15.49   33.84   29.61    N/A
     1048576         32768     float    none      -1    18.91   55.46   48.53      0    18.53   56.60   49.53    N/A
     2097152         65536     float    none      -1    27.11   77.35   67.68      0    26.76   78.36   68.56    N/A
     4194304        131072     float    none      -1    43.89   95.57   83.63      0    43.06   97.42   85.24    N/A
     8388608        262144     float    none      -1    83.12  100.92   88.31      0    82.54  101.64   88.93    N/A
    16777216        524288     float    none      -1    145.3  115.43  101.00      0    145.8  115.03  100.65    N/A
    33554432       1048576     float    none      -1    268.7  124.90  109.29      0    254.0  132.12  115.61    N/A
    67108864       2097152     float    none      -1    525.5  127.70  111.74      0    511.1  131.30  114.89    N/A
   134217728       4194304     float    none      -1    915.4  146.62  128.29      0    878.4  152.80  133.70    N/A
   268435456       8388608     float    none      -1   1710.9  156.90  137.29      0   1881.4  142.68  124.84    N/A
   536870912      16777216     float    none      -1   4476.7  119.93  104.94      0   3732.7  143.83  125.85    N/A
  1073741824      33554432     float    none      -1   7142.3  150.34  131.54      0   6841.9  156.94  137.32    N/A
  2147483648      67108864     float    none      -1    14373  149.41  130.74      0    13911  154.38  135.08    N/A
  4294967296     134217728     float    none      -1    28322  151.65  132.69      0    30555  140.56  122.99    N/A
  8589934592     268435456     float    none      -1    66211  129.74  113.52      0    66765  128.66  112.58    N/A
# Out of bounds values : 0 OK
# Avg bus bandwidth    : 50.6774
```

## 参考

* [coreweave/nccl-tests](https://github.com/CoreWeave/nccl-tests)